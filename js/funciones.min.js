function mostrar(){document.getElementById("contayuda").style.display="initial"}function ocultar(){document.getElementById("contayuda").style.display="none"}function cargaLibreria(a){libreriaDB.once("value",function(r){var i,e=r.val(),o=0;a.length=0;for(i in e)a[o]=e[i],a[o].iddb=i,a[o].indice=o,o++;actualizar(libreria)})}function añadeIddb(a,r){libreriaDB.once("value").then(function(i){var e,o=i.val(),l=0;for(e in o)l===r&&(a[l].iddb=e),l++})}function cambioRemoto(a,r){var i=libreria[r];i.indice=r,i.isbn=a.isbn,i.titulo=a.titulo,i.autor=a.autor,i.anio=a.anio,i.editorial=a.editorial,i.iddb=a.key,actualizar(libreria)}function chequeaBotones(){var a=Boolean($(".seleccionado")[0]);0!==libreria.length&&a?($("#modificar").removeClass("disabled"),$("#quitar").removeClass("disabled"),$("#anadir").addClass("disabled"),$("#buscar").addClass("disabled")):($("#modificar").addClass("disabled"),$("#quitar").addClass("disabled"),$("#anadir").removeClass("disabled"),$("#buscar").removeClass("disabled"))}function pintarLinea(a){$("#tableta tbody").append('<tr class="linea" onclick="seleccionar(this);"><td>'+a.isbn+"</td><td>"+a.titulo+"</td><td>"+a.autor+"</td><td>"+a.anio+"</td><td>"+a.editorial+'</td><td class="sr-only">'+a.indice+"</td></tr>")}function actualizar(a){if(0!==a.length){var r;if($(".linea").remove(),$("#busqueda").text(""),$("#resultado").text(""),$("th").css("background-color","#B4C9CC"),a===libreria||busquedaactiva===!1){for(r in a)pintarLinea(a[r]);arraymostrado=JSON.parse(JSON.stringify(a)),numerodefilas=Object.size(arraymostrado),$("#tableta").jTPS({perPages:[porpagina]})}else if(busquedaactiva===!0){for(r in a)pintarLinea(a[r]);arraymostrado=JSON.parse(JSON.stringify(a)),numerodefilas=Object.size(arraymostrado),$("#tableta").jTPS({perPages:[porpagina]}),$("th").css("background-color","#66ffb3"),$("#busqueda").text("Resultados de la búsqueda")}limpiaForm()}else $(".linea").remove();chequeaBotones()}function calculaIsbn10(a){var r,i,e=0;for(i=a.toLowerCase(),r=0;r<i.length-1;r++)e+=Number(i[r])*(r+1);return e%=11,10==e&&(e="x"),e==i[i.length-1]?!0:!1}function calculaIsbn13(a){var r,i=0;for(r=1;12>=r;r+=2)i=i+3*Number(a[r])+Number(a[r-1]);return i=10-i%10,i==Number(a[a.length-1])?!0:!1}function contarNumeros(a){var r,i=a.length;return 10===i?r=calculaIsbn10(a):13===i&&(r=calculaIsbn13(a)),r}function compararisbn(a){for(var r=libreria.length,i=0,e=0;r>e;e++)if(libreria[e].isbn.toLowerCase()==a.toLowerCase()){i=1;break}return 1==i?($("#isbnnull").html("Ya existe una entrada con este ISBN"),arrmensajes[0]=" OBLIGATORIO: Ya existe una entrada con este ISBN",salida=!1,$("#isbn").css("border","1px solid red"),!1):!0}function validarIsbn(){var a,r="",i=/^\s*(?:\d{9}[0-9xX]{1}|\d{13})\s*?/g,e=$("#isbn").val().trim();return i.test(e)?(e.toLowerCase(),contarNumeros(e)?($("#isbn").css("border","1px solid black"),a=!0):(r=" OBLIGATORIO: ISBN inválido, nro. de control incorrecto",$("#isbn").css("border","2px solid red"),a=!1)):($("#isbn").css("border","2px solid red"),r=" OBLIGATORIO: Formato de ISBN inválido 10/13 dígitos",$("#isbn").css("border","2px solid red"),a=!1),$("#isbnnull").html(r),arrmensajes[0]=r,a}function validarTitulo(){var a=/\w+/,r=$("#titulo").val().trim();return a.test(r)&&""!==r?($("#titulo").css("border","1px solid black"),$("#titulonull").html(""),arrmensajes[1]="",!0):($("#titulo").css("border","2px solid red"),$("#titulonull").html(" OBLIGATORIO: Título vacío"),arrmensajes[1]=" OBLIGATORIO: Título vacío",!1)}function validarAutor(){var a=$("#autor").val().trim();return""!==a?($("#autor").css("border","1px solid black"),$("#autornull").html(""),arrmensajes[2]="",!0):($("#autor").css("border","2px solid #a8410f"),$("#autornull").html(" Autor vacío"),arrmensajes[2]=" OPCIONAL: Autor vacío",!1)}function validarAnio(){var a=/\d{1,4}/,r=$("#anio").val().trim();return a.test(r)?($("#anio").css("border","1px solid black"),$("#anionull").html(""),arrmensajes[3]="",!0):($("#anio").css("border","2px solid #a8410f"),$("#anionull").html(" Año publ. incorrecto: 4 dígitos"),arrmensajes[3]=" OPCIONAL: Año publ. incorrecto: 4 dígitos",!1)}function validarEditorial(){var a=$("#editorial").val().trim();return""!==a?($("#editorial").css("border","1px solid black"),$("#editorialnull").html(""),arrmensajes[4]="",!0):($("#editorial").css("border","2px solid #a8410f"),$("#editorialnull").html(" Editorial vacía"),arrmensajes[4]=" OPCIONAL: Editorial vacía",!1)}function montaAlerta(){var a;if(alertmensaje="",0!==arrmensajes.length)for(a in arrmensajes)(""!==arrmensajes[a]||void 0!==arrmensajes[a])&&(alertmensaje+=arrmensajes[a]+"\n")}function validar(){var a,r,i,e,o,l={};return void 0===$("#oculto").val()?l.indice=Number(libreria.length):l.indice=Number($("#oculto").val()),a=validarIsbn(),l.isbn=a?$("#isbn").val():"",r=validarTitulo(),l.titulo=r?$("#titulo").val():"",i=validarAutor(),l.autor=i?$("#autor").val():"",e=validarAnio(),l.anio=e?$("#anio").val():"",o=validarEditorial(),l.editorial=o?$("#editorial").val():"",l.iddb="",a&&r?l:null}function limpiaForm(){$("input").val(""),$("input").css("border","1px solid black"),$(".mensaje").html(""),$("tr").removeClass("seleccionado"),arrmensajes.length=0}function objFormulario(){var a={};return void 0===$("#oculto").val()?a.indice=libreria.length:a.indice=Number($("#oculto").val()),a.isbn=$("#isbn").val(),a.titulo=$("#titulo").val(),a.autor=$("#autor").val(),a.anio=$("#anio").val(),a.editorial=$("#editorial").val(),a.iddb="",a}function formNoVacio(){var a=$("#isbn").val()+$("#titulo").val()+$("#autor").val()+$("#anio").val()+$("#editorial").val();return""===a.trim()?!1:!0}function comparaObj(a,r){var i,e,o=0;for(e in a){if(o>=6)break;if(a[e]!==r[e]){i=!1;break}i=!0,o++}return i}function sweetConfitm(a){swal({title:"¿Nueva selección?",text:"Los datos modificados en el formulario se perderán",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Seleccionar",cancelButtonText:"Cancelar",closeOnConfirm:!0,closeOnCancel:!0},function(r){if(r?user=!0:user=!1,user){console.log("ha entrado a cambiar"+user),$("tr").removeClass("seleccionado"),$(".mensaje").html(""),$("input").css("border","1px solid black"),$(a).addClass("seleccionado");var i,e=[];for(i=1;6>=i;i++)e.push($(".seleccionado :nth-of-type("+i+")").text());$("#isbn").val(e[0]),$("#titulo").val(e[1]),$("#autor").val(e[2]),$("#anio").val(e[3]),$("#editorial").val(e[4]),$("#oculto").val(e[5])}})}function seleccionar(a){var r;if(-1!==a.getAttribute("class").indexOf("seleccionado"))$(a).removeClass("seleccionado"),limpiaForm();else{var i=objFormulario();if(!comparaObj(i,libreria[i.indice])&&formNoVacio()?sweetConfitm(a):r=!0,r){console.log("ha entrado a cambiar"+r),$("tr").removeClass("seleccionado"),$(".mensaje").html(""),$("input").css("border","1px solid black"),$(a).addClass("seleccionado");var e,o=[];for(e=1;6>=e;e++)o.push($(".seleccionado :nth-of-type("+e+")").text());$("#isbn").val(o[0]),$("#titulo").val(o[1]),$("#autor").val(o[2]),$("#anio").val(o[3]),$("#editorial").val(o[4]),$("#oculto").val(o[5])}}chequeaBotones()}function alta(){$("#oculto").val(libreria.length);var a=validar(),r=compararisbn($("#isbn").val());a&&r?(nindice=libreria.length,libreria[nindice]=a,libreriaDB.push(a,function(){añadeIddb(libreria,nindice),actualizar(libreria)})):(montaAlerta(),sweetAlert("Datos erróneos, corregir:",alertmensaje))}function modificar(){if(datomodificado=validar(),datomodificado)aindice=datomodificado.indice,datomodificado.iddb=libreria[aindice].iddb,libreria[aindice]=datomodificado,db.ref("libreria/"+libreria[aindice].iddb).set(datomodificado),actualizar(libreria);else{montaAlerta();sweetAlert("Datos erróneos, corregir:",alertmensaje)}chequeaBotones()}function borrar(){swal({title:"¿Está seguro?",text:"La entrada de la base de datos no se podrá recuperar",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, bórralo",cancelButtonText:"Cancelar",closeOnConfirm:!0,closeOnCancel:!0},function(a){if(a){var r,i=$("#oculto").val(),e=libreria[i].iddb;for(db.ref("libreria/"+e).remove(),libreria.splice(i,1),r=0;r<libreria.length;r++)libreria[r].indice=r;actualizar(libreria)}})}function busqueda(){busquedas=[],busquedasaux=[];var a;$("#resultado").text("");var r=!1;$("#isbn").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&r===!1?(a=$("#isbn").val(),abuscar("isbn",a)):busquedasactuales>0&&abuscarb("isbn",a)),$("#titulo").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&r===!1?(a=$("#titulo").val(),abuscar("titulo",a)):busquedasactuales>0&&(a=$("#titulo").val(),abuscarb("titulo",a))),$("#autor").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&r===!1?(a=$("#autor").val(),abuscar("autor",a)):busquedasactuales>0&&(a=$("#autor").val(),abuscarb("autor",a))),$("#anio").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&r===!1?(a=$("#anio").val(),abuscar("anio",a)):busquedasactuales>0&&(a=$("#anio").val(),abuscarb("anio",a))),$("#editorial").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&r===!1?(a=$("#editorial").val(),abuscar("editorial",a)):busquedasactuales>0&&(a=$("#editorial").val(),abuscarb("editorial",a))),actualizar(busquedas)}function abuscar(a,r){for(librosactuales=libreria.length,i=0;i<librosactuales;i++)-1!=libreria[i][a].toLowerCase().indexOf(r.toLowerCase())&&busquedas.push(libreria[i]);0===busquedas.length&&(sinencontrar=!0,$("#resultado").text("No encontramos libros que coincidan con los valores introducidos"),$("#busqueda").text("Resultados de la búsqueda"),$("th").css("background-color","#66ffb3"))}function abuscarb(a,r){busquedasaux=[],busquedasactuales=busquedas.length;for(var i=0;i<busquedasactuales;i++)-1!=busquedas[i][a].toLowerCase().indexOf(r.toLowerCase())&&busquedasaux.push(busquedas[i]);busquedas=JSON.parse(JSON.stringify(busquedasaux)),0===busquedas.length&&($("#resultado").text("No encontramos libros que coincidan con los valores introducidos"),$("#busqueda").text("Resultados de la búsqueda"),$("th").css("background-color","#66ffb3"))}function numeroAzar(){var a=Math.round(10*Math.random());return 10===a&&(a=9),a}function cargaDB(){var a=libreria.length,r={indice:a,isbn:arrisbn[a],titulo:arrtitulo[numeroAzar()],autor:arrautor[numeroAzar()],anio:arranio[numeroAzar()],editorial:arreditorial[numeroAzar()],iddb:""};libreria[a]=r,libreriaDB.push(libreria[a])}var libreria=[],busquedas=[],busquedasaux=[],arrmensajes=[],alertmensaje,numerodefilas,porpagina="8",arraymostrado=[],busquedaactiva=!1;Object.size=function(a){var r,i=0;for(r in a)a.hasOwnProperty(r)&&i++;return i};var db=firebase.database(),libreriaDB=db.ref("libreria");$(function(){cargaLibreria(libreria),$("#isbn").bind("input change",validarIsbn),$("#isbn").blur(validarIsbn),$("#titulo").bind("input change",validarTitulo),$("#titulo").blur(validarTitulo),$("#autor").bind("input change",validarAutor),$("#autor").blur(validarAutor),$("#anio").bind("input change",validarAnio),$("#anio").blur(validarAnio),$("#editorial").bind("input change",validarEditorial),$("#editorial").blur(validarEditorial),$("#resetear").mouseover(function(){formNoVacio()||""!==$(".mensaje").html()?$("#resetear").removeClass("disabled"):$("#resetear").addClass("disabled")}),$("#anadir").click(function(){Boolean($(".seleccionado")[0])||alta()}),$("#buscar").click(function(){if(!Boolean($(".seleccionado")[0]))switch($("#buscar").text()){case"BUSCAR":formNoVacio()&&(busquedaactiva=!0,$("#buscar").text("VOLVER"),busqueda());break;case"VOLVER":$("#buscar").text("BUSCAR"),busquedaactiva=!1,actualizar(libreria)}}),$("#modificar").click(function(){Boolean($(".seleccionado")[0])&&modificar()}),$("#quitar").click(function(){Boolean($(".seleccionado")[0])&&borrar()}),$("#resetear").click(function(){$("#resetear").hasClass("disabled")||(limpiaForm(),chequeaBotones())}),$("#filasPagina8").click(function(){porpagina=8,actualizar(arraymostrado)}),$("#filasPagina16").click(function(){porpagina=16,actualizar(arraymostrado)}),$("#filasPagina32").click(function(){porpagina=32,actualizar(arraymostrado)}),$("#filasPagina64").click(function(){porpagina=64,actualizar(arraymostrado)}),$("#filasPaginaAll").click(function(){porpagina="All",actualizar(arraymostrado)})}),libreriaDB.on("child_changed",function(a){var r=a.val();console.log("antes de chgremoto",r),cambioRemoto(r,Number(r.indice))}),libreriaDB.on("value",function(a){var r=a.val();console.log("antes de addremoto",r),cargaLibreria(libreria)}),libreriaDB.on("child_removed",function(a){var r=a.val();console.log("antes de rmvremoto",r),libreria.splice(r.indice,1);for(var i=0;i<libreria.length;i++)libreria[i].indice=i;actualizar(libreria)});var arrisbn=["123456789X","1234567890128","1111111111116","1212121212128","1452367892","9999999999","4561597530","951357654x","258456159x","7531598523"],arrtitulo=["JQuery y tú","El linter, tu gran amigo","100 razones para odiar IE","Oda al pantallazo azul","El Señor de los gramillos","Mucho ruido y pocos altramuces","LSD y programación","10 pasos para desengancharte del código","Guerra y Paz III","Cumbres con nubes y claros"],arrautor=["Guillermo Puertas","Java El Hutt","León Tostón","Alan Turning","Adrián Arteaga","Juan José Basco","Pablo Andueza","Pablo Garrido","Rubén Álvarez","Chespirito"],arranio=["1234","5678","9123","2016","1975","1981","1732","2222","1997","2010"],arreditorial=["Satelite","Bruguerra","Chonibooks","Mocosoft","Ran-Ma","Livros pa' que","Editorial","Exoplaneta","Macgrou Jill","Salbamé Delujs"];