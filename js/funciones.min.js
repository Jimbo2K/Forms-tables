function mostrar(){document.getElementById("contayuda").style.display="initial"}function ocultar(){document.getElementById("contayuda").style.display="none"}function cargaLibreria(a){libreriaDB.once("value",function(i){var e,r=i.val(),o=0;a.length=0;for(e in r)a[o]=r[e],a[o].iddb=e,a[o].indice=o,o++;actualizar(libreria)})}function añadeIddb(a,i){libreriaDB.once("value").then(function(e){var r,o=e.val(),l=0;for(r in o)l===i&&(a[l].iddb=r),l++})}function cambioRemoto(a,i){var e=libreria[i];e.indice=i,e.isbn=a.isbn,e.titulo=a.titulo,e.autor=a.autor,e.anio=a.anio,e.editorial=a.editorial,e.iddb=a.key,actualizar(libreria)}function chequeaBotones(){var a=Boolean($(".seleccionado")[0]);0!==libreria.length&&a?($("#modificar").removeClass("disabled"),$("#quitar").removeClass("disabled"),$("#anadir").addClass("disabled"),$("#buscar").addClass("disabled")):($("#modificar").addClass("disabled"),$("#quitar").addClass("disabled"),$("#anadir").removeClass("disabled"),$("#buscar").removeClass("disabled"))}function pintarLinea(a){$("#tableta tbody").append('<tr class="linea" onclick="seleccionar(this);"><td>'+a.isbn+"</td><td>"+a.titulo+"</td><td>"+a.autor+"</td><td>"+a.anio+"</td><td>"+a.editorial+'</td><td class="sr-only">'+a.indice+"</td></tr>")}function actualizar(a){if(0!==a.length){var i;if($(".linea").remove(),$("#busqueda").text(""),$("#resultado").text(""),$("th").css("background-color","#B4C9CC"),a===libreria||busquedaactiva===!1){for(i in a)pintarLinea(a[i]);arraymostrado=JSON.parse(JSON.stringify(a)),numerodefilas=Object.size(arraymostrado),$("#tableta").jTPS({perPages:[porpagina]})}else if(busquedaactiva===!0){for(i in a)pintarLinea(a[i]);arraymostrado=JSON.parse(JSON.stringify(a)),numerodefilas=Object.size(arraymostrado),$("#tableta").jTPS({perPages:[porpagina]}),$("th").css("background-color","#66ffb3"),$("#busqueda").text("Resultados de la búsqueda")}limpiaForm()}else $(".linea").remove();chequeaBotones()}function calculaIsbn10(a){var i,e,r=0;for(e=a.toLowerCase(),i=0;i<e.length-1;i++)r+=Number(e[i])*(i+1);return r%=11,10==r&&(r="x"),r==e[e.length-1]?!0:!1}function calculaIsbn13(a){var i,e=0;for(i=1;12>=i;i+=2)e=e+3*Number(a[i])+Number(a[i-1]);return e=10-e%10,e==Number(a[a.length-1])?!0:!1}function contarNumeros(a){var i,e=a.length;return 10===e?i=calculaIsbn10(a):13===e&&(i=calculaIsbn13(a)),i}function compararisbn(a){for(var i=libreria.length,e=0,r=0;i>r;r++)if(libreria[r].isbn.toLowerCase()==a.toLowerCase()){e=1;break}return 1==e?($("#isbnnull").html("Ya existe una entrada con este ISBN"),arrmensajes[0]=" OBLIGATORIO: Ya existe una entrada con este ISBN",salida=!1,$("#isbn").css("border","1px solid red"),!1):!0}function validarIsbn(){var a,i="",e=/^\s*(?:\d{9}[0-9xX]{1}|\d{13})\s*?/g,r=$("#isbn").val().trim();return e.test(r)?(r.toLowerCase(),contarNumeros(r)?($("#isbn").css("border","1px solid black"),a=!0):(i=" OBLIGATORIO: ISBN inválido, nro. de control incorrecto",$("#isbn").css("border","2px solid red"),a=!1)):($("#isbn").css("border","2px solid red"),i=" OBLIGATORIO: Formato de ISBN inválido 10/13 dígitos",$("#isbn").css("border","2px solid red"),a=!1),$("#isbnnull").html(i),arrmensajes[0]=i,a}function validarTitulo(){var a=/\w+/,i=$("#titulo").val().trim();return a.test(i)&&""!==i?($("#titulo").css("border","1px solid black"),$("#titulonull").html(""),arrmensajes[1]="",!0):($("#titulo").css("border","2px solid red"),$("#titulonull").html(" OBLIGATORIO: Título vacío"),arrmensajes[1]=" OBLIGATORIO: Título vacío",!1)}function validarAutor(){var a=$("#autor").val().trim();return""!==a?($("#autor").css("border","1px solid black"),$("#autornull").html(""),arrmensajes[2]="",!0):($("#autor").css("border","2px solid #a8410f"),$("#autornull").html(" Autor vacío"),arrmensajes[2]=" OPCIONAL: Autor vacío",!1)}function validarAnio(){var a=/\d{1,4}/,i=$("#anio").val().trim();return a.test(i)?($("#anio").css("border","1px solid black"),$("#anionull").html(""),arrmensajes[3]="",!0):($("#anio").css("border","2px solid #a8410f"),$("#anionull").html(" Año publ. incorrecto: 4 dígitos"),arrmensajes[3]=" OPCIONAL: Año publ. incorrecto: 4 dígitos",!1)}function validarEditorial(){var a=$("#editorial").val().trim();return""!==a?($("#editorial").css("border","1px solid black"),$("#editorialnull").html(""),arrmensajes[4]="",!0):($("#editorial").css("border","2px solid #a8410f"),$("#editorialnull").html(" Editorial vacía"),arrmensajes[4]=" OPCIONAL: Editorial vacía",!1)}function montaAlerta(){var a;if(alertmensaje="",0!==arrmensajes.length)for(a in arrmensajes)(""!==arrmensajes[a]||void 0!==arrmensajes[a])&&(alertmensaje+=arrmensajes[a]+"\n")}function validar(){var a,i,e,r,o,l={};return void 0===$("#oculto").val()?l.indice=Number(libreria.length):l.indice=Number($("#oculto").val()),a=validarIsbn(),l.isbn=a?$("#isbn").val():"",i=validarTitulo(),l.titulo=i?$("#titulo").val():"",e=validarAutor(),l.autor=e?$("#autor").val():"",r=validarAnio(),l.anio=r?$("#anio").val():"",o=validarEditorial(),l.editorial=o?$("#editorial").val():"",l.iddb="",a&&i?l:null}function limpiaForm(){$("input").val(""),$("input").css("border","1px solid black"),$(".mensaje").html(""),$("tr").removeClass("seleccionado"),arrmensajes.length=0}function objFormulario(){var a={};return void 0===$("#oculto").val()?a.indice=libreria.length:a.indice=Number($("#oculto").val()),a.isbn=$("#isbn").val(),a.titulo=$("#titulo").val(),a.autor=$("#autor").val(),a.anio=$("#anio").val(),a.editorial=$("#editorial").val(),a.iddb="",a}function formNoVacio(){var a=$("#isbn").val()+$("#titulo").val()+$("#autor").val()+$("#anio").val()+$("#editorial").val();return""===a.trim()?!1:!0}function comparaObj(a,i){var e,r,o=0;for(r in a){if(o>=6)break;if(a[r]!==i[r]){e=!1;break}e=!0,o++}return e}function sweetConfitm(a){swal({title:"¿Nueva selección?",text:"Los datos modificados en el formulario se perderán",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Seleccionar",cancelButtonText:"Cancelar",closeOnConfirm:!0,closeOnCancel:!0},function(i){if(i?user=!0:user=!1,user){$("tr").removeClass("seleccionado"),$(".mensaje").html(""),$("input").css("border","1px solid black"),$(a).addClass("seleccionado");var e,r=[];for(e=1;6>=e;e++)r.push($(".seleccionado :nth-of-type("+e+")").text());$("#isbn").val(r[0]),$("#titulo").val(r[1]),$("#autor").val(r[2]),$("#anio").val(r[3]),$("#editorial").val(r[4]),$("#oculto").val(r[5])}})}function seleccionar(a){var i;if(-1!==a.getAttribute("class").indexOf("seleccionado"))$(a).removeClass("seleccionado"),limpiaForm();else{var e=objFormulario();if(!comparaObj(e,libreria[e.indice])&&formNoVacio()?sweetConfitm(a):i=!0,i){$("tr").removeClass("seleccionado"),$(".mensaje").html(""),$("input").css("border","1px solid black"),$(a).addClass("seleccionado");var r,o=[];for(r=1;6>=r;r++)o.push($(".seleccionado :nth-of-type("+r+")").text());$("#isbn").val(o[0]),$("#titulo").val(o[1]),$("#autor").val(o[2]),$("#anio").val(o[3]),$("#editorial").val(o[4]),$("#oculto").val(o[5])}}chequeaBotones()}function alta(){$("#oculto").val(libreria.length);var a=validar(),i=compararisbn($("#isbn").val());a&&i?(nindice=libreria.length,libreria[nindice]=a,libreriaDB.push(a,function(){añadeIddb(libreria,nindice),actualizar(libreria)})):(montaAlerta(),sweetAlert("Datos erróneos, corregir:",alertmensaje))}function modificar(){if(datomodificado=validar(),datomodificado)aindice=datomodificado.indice,datomodificado.iddb=libreria[aindice].iddb,libreria[aindice]=datomodificado,db.ref("libreria/"+libreria[aindice].iddb).set(datomodificado),actualizar(libreria);else{montaAlerta();sweetAlert("Datos erróneos, corregir:",alertmensaje)}chequeaBotones()}function borrar(){swal({title:"¿Está seguro?",text:"La entrada de la base de datos no se podrá recuperar",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Si, bórralo",cancelButtonText:"Cancelar",closeOnConfirm:!0,closeOnCancel:!0},function(a){if(a){var i,e=$("#oculto").val(),r=libreria[e].iddb;for(db.ref("libreria/"+r).remove(),libreria.splice(e,1),i=0;i<libreria.length;i++)libreria[i].indice=i;actualizar(libreria)}})}function busqueda(){busquedas=[],busquedasaux=[];var a;$("#resultado").text("");var i=!1;$("#isbn").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#isbn").val(),abuscar("isbn",a)):busquedasactuales>0&&abuscarb("isbn",a)),$("#titulo").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#titulo").val(),abuscar("titulo",a)):busquedasactuales>0&&(a=$("#titulo").val(),abuscarb("titulo",a))),$("#autor").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#autor").val(),abuscar("autor",a)):busquedasactuales>0&&(a=$("#autor").val(),abuscarb("autor",a))),$("#anio").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#anio").val(),abuscar("anio",a)):busquedasactuales>0&&(a=$("#anio").val(),abuscarb("anio",a))),$("#editorial").val()&&(busquedasactuales=busquedas.length,0===busquedasactuales&&i===!1?(a=$("#editorial").val(),abuscar("editorial",a)):busquedasactuales>0&&(a=$("#editorial").val(),abuscarb("editorial",a))),actualizar(busquedas)}function abuscar(a,e){for(librosactuales=libreria.length,i=0;i<librosactuales;i++)-1!=libreria[i][a].toLowerCase().indexOf(e.toLowerCase())&&busquedas.push(libreria[i]);0===busquedas.length&&(sinencontrar=!0,$("#resultado").text("No encontramos libros que coincidan con los valores introducidos"),$("#busqueda").text("Resultados de la búsqueda"),$("th").css("background-color","#66ffb3"))}function abuscarb(a,i){busquedasaux=[],busquedasactuales=busquedas.length;for(var e=0;e<busquedasactuales;e++)-1!=busquedas[e][a].toLowerCase().indexOf(i.toLowerCase())&&busquedasaux.push(busquedas[e]);busquedas=JSON.parse(JSON.stringify(busquedasaux)),0===busquedas.length&&($("#resultado").text("No encontramos libros que coincidan con los valores introducidos"),$("#busqueda").text("Resultados de la búsqueda"),$("th").css("background-color","#66ffb3"))}var libreria=[],busquedas=[],busquedasaux=[],arrmensajes=[],alertmensaje,numerodefilas,porpagina="8",arraymostrado=[],busquedaactiva=!1;Object.size=function(a){var i,e=0;for(i in a)a.hasOwnProperty(i)&&e++;return e};var db=firebase.database(),libreriaDB=db.ref("libreria");$(function(){cargaLibreria(libreria),$("#isbn").bind("input change",validarIsbn),$("#isbn").blur(validarIsbn),$("#titulo").bind("input change",validarTitulo),$("#titulo").blur(validarTitulo),$("#autor").bind("input change",validarAutor),$("#autor").blur(validarAutor),$("#anio").bind("input change",validarAnio),$("#anio").blur(validarAnio),$("#editorial").bind("input change",validarEditorial),$("#editorial").blur(validarEditorial),$("#resetear").mouseover(function(){formNoVacio()||""!==$(".mensaje").html()?$("#resetear").removeClass("disabled"):$("#resetear").addClass("disabled")}),$("#anadir").click(function(){Boolean($(".seleccionado")[0])||alta()}),$("#buscar").click(function(){if(!Boolean($(".seleccionado")[0]))switch($("#buscar").text()){case"BUSCAR":formNoVacio()&&(busquedaactiva=!0,$("#buscar").text("VOLVER"),busqueda());break;case"VOLVER":$("#buscar").text("BUSCAR"),busquedaactiva=!1,actualizar(libreria)}}),$("#modificar").click(function(){Boolean($(".seleccionado")[0])&&modificar()}),$("#quitar").click(function(){Boolean($(".seleccionado")[0])&&borrar()}),$("#resetear").click(function(){$("#resetear").hasClass("disabled")||(limpiaForm(),chequeaBotones())}),$("#filasPagina8").click(function(){porpagina=8,actualizar(arraymostrado)}),$("#filasPagina16").click(function(){porpagina=16,actualizar(arraymostrado)}),$("#filasPagina32").click(function(){porpagina=32,actualizar(arraymostrado)}),$("#filasPagina64").click(function(){porpagina=64,actualizar(arraymostrado)}),$("#filasPaginaAll").click(function(){porpagina="All",actualizar(arraymostrado)})}),libreriaDB.on("child_changed",function(a){var i=a.val();cambioRemoto(i,Number(i.indice))}),libreriaDB.on("value",function(a){a.val();cargaLibreria(libreria)}),libreriaDB.on("child_removed",function(a){var i=a.val();libreria.splice(i.indice,1);for(var e=0;e<libreria.length;e++)libreria[e].indice=e;actualizar(libreria)});